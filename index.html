<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Performance, Forms, Commitments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-bg: #f9f9f9;
      --primary-accent: #d32f2f;
      --primary-border: #d1d5db;
      --primary-radius: 8px;
      --primary-font: 'Segoe UI', Arial, sans-serif;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg);
      font-family: var(--primary-font);
      color: #222;
      min-height: 100vh;
    }
    body {
      max-width: 570px;
      margin: 0 auto;
      padding: 1em 0.5em 3em 0.5em;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 1em;
      text-align: center;
      color: var(--primary-accent);
      letter-spacing: 1px;
    }
    form {
      background: #fff;
      padding: 1.2em 1em 1.2em 1em;
      border-radius: var(--primary-radius);
      box-shadow: 0 2px 8px 0 #0001;
      margin-bottom: 1.5em;
    }
    label {
      display: block;
      margin-top: 1em;
      font-weight: 500;
      font-size: 1em;
    }
    select, input[type="text"], button {
      font-size: 1em;
      width: 100%;
      padding: 0.65em;
      border: 1px solid var(--primary-border);
      border-radius: var(--primary-radius);
      box-sizing: border-box;
      margin-top: 0.5em;
      margin-bottom: 0.5em;
      background: #fcfcfc;
      transition: box-shadow 0.2s, border 0.2s;
    }
    button {
      background: var(--primary-accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1em;
      margin-bottom: 0;
      border: none;
      transition: background 0.2s;
      font-size: 1.05em;
    }
    .actions {
      display: flex;
      gap: 0.7em;
      margin-top: 1.2em;
      flex-wrap: wrap;
    }
    .form-metrics label {
      margin: 0.8em 0 0.2em 0;
      font-weight: 400;
      font-size: 0.98em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 1em;
      background: #fff;
      border-radius: var(--primary-radius);
      overflow: hidden;
      box-shadow: 0 2px 8px 0 #0001;
      font-size: 0.97em;
    }
    th, td {
      border: 1px solid var(--primary-border);
      padding: 0.5em 0.2em;
      text-align: center;
    }
    th {
      background: #ffebee;
      color: var(--primary-accent);
    }
    #tableTitle {
      text-align: center;
      font-weight: 600;
      font-size: 1.13em;
      margin: 1.1em 0 0.2em 0;
      color: var(--primary-accent);
    }
    .hidden { display: none !important; }
  </style>
  <script src="hierarchy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Weekly Business Review</h1>

  <!-- Selection Page -->
  <div id="selectionSection">
    <form id="selectionForm">
      <label>Area:<select id="areaDropdown" required><option value="">--Select Area--</option></select></label>
      <label>Region:<select id="regionDropdown" required disabled><option value="">--Select Region--</option></select></label>
      <label>District:<select id="districtDropdown" required disabled><option value="">--Select District--</option></select></label>
      <label>Store:<select id="storeDropdown" required disabled><option value="">--Select Store--</option></select></label>
      <label>Select Week:<select id="weekSelect" required>
        <option value="">--Select Week--</option>
        <option value="1">Week 1</option>
        <option value="2">Week 2</option>
        <option value="3">Week 3</option>
        <option value="4">Week 4</option>
        <option value="5">Week 5</option>
      </select></label>
      <div class="actions">
        <button type="submit">Next</button>
      </div>
    </form>
  </div>

  <!-- Data Entry Page -->
  <div id="metricsSection" class="hidden">
    <form id="metricsForm">
      <div class="form-metrics"></div>
      <div class="actions">
        <button type="button" id="resetTargets">Reset Targets</button>
        <button type="button" id="backButton">Back</button>
        <button type="submit">Next</button>
      </div>
    </form>
  </div>

  <!-- Data Table Page -->
  <div id="tableSection" class="hidden">
    <h2 id="tableTitle"></h2>
    <table>
      <thead>
        <tr>
          <th>Metric</th>
          <th>Target</th>
          <th>Week 1</th>
          <th>Week 2</th>
          <th>Week 3</th>
          <th>Week 4</th>
          <th>Week 5</th>
        </tr>
      </thead>
      <tbody id="metricsTable"></tbody>
    </table>
    <div class="actions">
      <button id="backToMetrics">Back</button>
      <button id="clearAllData">Clear All Data</button>
      <button id="printTableBtn" type="button">Print</button>
    </div>
  </div>

<script>
const metrics = [
  "Trending Net GP", "Current Rank", "Current Quintile", "Bottom Metrics",
  "GP % Target", "GP per HR", "Voice", "BTS", "TFB", "VAF",
  "Accessories", "CSAT", "AAL Attainment"
];

const defaultTargets = {
  "Trending Net GP": "",
  "Current Rank": "86",
  "Current Quintile": "1",
  "Bottom Metrics": "4th/5th",
  "GP % Target": "125%",
  "GP per HR": "$35",
  "Voice": "125%",
  "BTS": "125%",
  "TFB": "125%",
  "VAF": "$19",
  "Accessories": "125%",
  "CSAT": "9.5",
  "AAL Attainment": "125%"
};

let allData = {};
const STORAGE_KEY = "locationPerformanceDataV2";
let selectedStore = "", selectedWeek = "";

function loadAllData(){
  const raw = localStorage.getItem(STORAGE_KEY);
  allData = raw? JSON.parse(raw):{};
}
function saveAllData(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
}

document.getElementById("selectionForm").onsubmit = e => {
  e.preventDefault();
  selectedStore = document.getElementById("storeDropdown").value;
  selectedWeek = document.getElementById("weekSelect").value;
  loadAllData();
  let prev = (allData[selectedStore] && allData[selectedStore][selectedWeek]) || {};
  document.querySelector(".form-metrics").innerHTML = metrics.map(m=>`
    <label>${m} - Target: <input type="text" name="${m}_target" value="${prev[m+"_target"]||defaultTargets[m]||""}" /></label>
    <label>${m} - Current: <input type="text" name="${m}" value="${prev[m]||""}" /></label>
  `).join(" ");
  document.getElementById("selectionSection").classList.add("hidden");
  document.getElementById("metricsSection").classList.remove("hidden");
};

document.getElementById("metricsForm").onsubmit = e => {
  e.preventDefault();
  let entry = {};
  metrics.forEach(m=>{
    entry[m] = e.target[m].value;
    entry[m+"_target"] = e.target[m+"_target"].value;
  });
  if(!allData[selectedStore]) allData[selectedStore] = {};
  allData[selectedStore][selectedWeek] = entry;
  saveAllData();
  renderTable();
};

document.getElementById("resetTargets").onclick = ()=>{
  metrics.forEach(m=>{
    document.getElementsByName(m+"_target")[0].value = defaultTargets[m]||"";
  });
  // save immediately
  document.getElementById("metricsForm").dispatchEvent(new Event("submit", {cancelable:true}));
};

function renderTable(){
  loadAllData();
  let tbody = document.getElementById("metricsTable");
  let data = allData[selectedStore]||{};
  tbody.innerHTML = metrics.map(m=>{
    let row = `<td>${m}</td>`;
    row += `<td>${data[1]&&data[1][m+"_target"]? data[1][m+"_target"]: defaultTargets[m]||""}</td>`;
    for(let i=1;i<=5;i++){
      row += `<td>${data[i]&&data[i][m]? data[i][m]:""}</td>`;
    }
    return `<tr>${row}</tr>`;
  }).join(" ");
  document.getElementById("metricsSection").classList.add("hidden");
  document.getElementById("tableSection").classList.remove("hidden");
}
</script>
</body>
</html>
