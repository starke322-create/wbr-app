<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Performance, Forms, Commitments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1, h2 { margin-bottom: 10px; }
    .hidden { display: none; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    table, th, td { border: 1px solid #ccc; }
    th, td { padding: 6px; text-align: center; }
    .actions { margin-top: 15px; }
    .metric-entry { margin: 8px 0; }
    .metric-entry label { display: inline-block; width: 150px; }
    .metric-entry input { width: 120px; margin-right: 10px; }
  </style>
  <script src="hierarchy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Weekly Business Review</h1>

  <!-- Selection Page -->
  <div id="selectionSection">
    <button onclick="showMetricsEntry()">Enter Data</button>
    <button onclick="showTable()">View Table</button>
  </div>

  <!-- Data Entry Page -->
  <div id="metricsSection" class="hidden">
    <h2>Enter Weekly Data</h2>
    <form id="metricsForm"></form>
    <div class="actions">
      <button type="button" onclick="saveMetrics()">Save Entry</button>
      <button type="button" id="resetTargets">Reset Targets</button>
      <button type="button" onclick="backToSelection()">Back</button>
    </div>
  </div>

  <!-- Data Table Page -->
  <div id="tableSection" class="hidden">
    <div id="printMeta"></div>
    <h2 id="tableTitle">Metrics Table</h2>
    <table>
      <thead>
        <tr class="header-row">
          <th>Metric</th>
          <th>Target</th>
          <th>Week 1</th>
          <th>Week 2</th>
          <th>Week 3</th>
          <th>Week 4</th>
          <th>Week 5</th>
        </tr>
      </thead>
      <tbody id="metricsTable"></tbody>
    </table>
    <div class="actions" id="tableActions">
      <button id="backToMetrics">Back</button>
      <button id="clearAllData">Clear All Data</button>
      <button id="printTableBtn" type="button">Print</button>
    </div>
  </div>

  <script>
    const defaultTargets = {
      "Net Trending GP": "",
      "Current Rank": "86",
      "Current Quintile": "1",
      "Bottom Metrics": "4th/5th",
      "GP % Target": "125%",
      "GP per HR": "$35",
      "Voice": "125%",
      "BTS": "125%",
      "TFB": "125%",
      "VAF": "$19",
      "Accessories": "125%",
      "CSAT": "9.5",
      "AAL Attainment": "125%"
    };

    let savedData = JSON.parse(localStorage.getItem("metricsData")) || {};
    let targets = { ...defaultTargets };

    function showMetricsEntry() {
      document.getElementById("selectionSection").classList.add("hidden");
      document.getElementById("metricsSection").classList.remove("hidden");
      buildForm();
    }

    function showTable() {
      document.getElementById("selectionSection").classList.add("hidden");
      document.getElementById("tableSection").classList.remove("hidden");
      renderTable();
    }

    function backToSelection() {
      document.getElementById("metricsSection").classList.add("hidden");
      document.getElementById("tableSection").classList.add("hidden");
      document.getElementById("selectionSection").classList.remove("hidden");
    }

    function buildForm() {
      const form = document.getElementById("metricsForm");
      form.innerHTML = "";
      for (let metric in defaultTargets) {
        const div = document.createElement("div");
        div.className = "metric-entry";
        div.innerHTML = `
          <label>${metric}:</label>
          <input type="text" name="target-${metric}" value="${targets[metric] || ''}" placeholder="Target">
          <input type="text" name="current-${metric}" placeholder="Current">
        `;
        form.appendChild(div);
      }
    }

    function saveMetrics() {
      const formData = new FormData(document.getElementById("metricsForm"));
      for (let metric in defaultTargets) {
        targets[metric] = formData.get(`target-${metric}`) || defaultTargets[metric];
        if (!savedData[metric]) savedData[metric] = { target: targets[metric], weeks: [] };
        savedData[metric].target = targets[metric];
        savedData[metric].weeks.push(formData.get(`current-${metric}`));
      }
      localStorage.setItem("metricsData", JSON.stringify(savedData));
      alert("Data saved!");
    }

    function renderTable() {
      const tbody = document.getElementById("metricsTable");
      tbody.innerHTML = "";
      for (let metric in defaultTargets) {
        const row = document.createElement("tr");
        const data = savedData[metric] || { target: targets[metric], weeks: [] };
        row.innerHTML = `
          <td>${metric}</td>
          <td>${data.target || ""}</td>
          ${Array.from({ length: 5 }).map((_, i) => `<td>${data.weeks[i] || ""}</td>`).join("")}
        `;
        tbody.appendChild(row);
      }
    }

    document.getElementById("resetTargets").onclick = function() {
      targets = { ...defaultTargets };
      buildForm();
    };

    document.getElementById("backToMetrics").onclick = backToSelection;
    document.getElementById("clearAllData").onclick = function() {
      if (confirm("Clear all saved data?")) {
        localStorage.removeItem("metricsData");
        savedData = {};
        renderTable();
      }
    };

    // Print screenshot of current tableSection
    document.getElementById("printTableBtn").onclick = function() {
      html2canvas(document.getElementById("tableSection")).then(function(canvas) {
        let win = window.open("", "_blank");
        win.document.write(`
          <html>
          <head>
            <title>Print Table</title>
            <style>
              body { margin:0; background:#fff; width:100vw; height:100vh; }
              .centered-print { display:flex; align-items:center; justify-content:center; height:100vh; width:100vw; }
              canvas { max-width:90vw; max-height:90vh; display:block; margin:auto; }
            </style>
          </head>
          <body>
            <div class="centered-print" id="canvasContainer"></div>
          </body>
          </html>
        `);
        win.document.close();
        win.onload = function() {
          win.document.getElementById("canvasContainer").appendChild(canvas);
          setTimeout(() => win.print(), 400);
        };
      });
    };
  </script>
</body>
</html>
