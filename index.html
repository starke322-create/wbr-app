<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Performance, Forms, Commitments</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 2em; }
    h1 { margin-bottom: 1em; }
    .hidden { display: none; }
    table { border-collapse: collapse; margin-top: 2em; min-width: 600px; }
    th, td { border: 1px solid #ccc; padding: 0.5em 1em; text-align: center; }
    th { background: #f0f0f0; }
    label { display: block; margin-top: 1em; }
    select, input[type="text"] { width: 280px; }
    button { margin-top: 2em; }
    .form-metrics { margin-top: 2em; }
    .header-row th { font-size: 1.1em; }
    .actions { margin-top: 1.5em; }
  </style>
</head>
<body>
  <h1>Performance, Forms, Commitments</h1>

  <!-- Page 1: Location and Week selection -->
  <div id="locationSection">
    <form id="locationForm" autocomplete="off">
      <label>
        Location:
        <select id="locationDropdown" required>
          <option value="">--Select Location--</option>
          <!-- (Your location options here. Omitted for brevity, use your previous list.) -->
        </select>
      </label>
      <label>
        Select Week: 
        <select id="weekSelect" required>
          <option value="">--Select Week--</option>
          <option value="1">Week 1</option>
          <option value="2">Week 2</option>
          <option value="3">Week 3</option>
          <option value="4">Week 4</option>
          <option value="5">Week 5</option>
        </select>
      </label>
      <br>
      <button type="submit">Next</button>
    </form>
  </div>

  <!-- Page 2: Metrics input and table -->
  <div id="metricsSection" class="hidden">
    <form id="metricsForm" autocomplete="off">
      <div class="form-metrics"></div>
      <div class="actions">
        <button type="submit">Calculate</button>
        <button type="button" id="editLocation">Edit Location/Week</button>
      </div>
    </form>

    <div id="tableSection" class="hidden">
      <h2 id="tableTitle"></h2>
      <table>
        <thead>
          <tr class="header-row">
            <th>Metric</th>
            <th>Week 1</th>
            <th>Week 2</th>
            <th>Week 3</th>
            <th>Week 4</th>
            <th>Week 5</th>
          </tr>
        </thead>
        <tbody id="metricsTable"></tbody>
      </table>
      <div class="actions">
        <button id="editMetrics">Edit Inputs</button>
        <button id="clearAllData">Clear All Data</button>
      </div>
    </div>
  </div>

  <script>
    // Metrics and formatting
    const metrics = [
      "Trending Net GP", "Current Rank", "Current Quintile", "Bottom Metrics",
      "GP % Target", "GP per HR", "Voice", "BTS", "TFB", "VAF",
      "Accessories", "CSAT", "AAL Attainment"
    ];

    // Map: metric -> formatting function
    const metricFormatters = {
      "Trending Net GP": v => formatDollarNoCents(v),
      "GP % Target": v => formatPercentNoDecimal(v),
      "GP per HR": v => formatDollar(v),
      "Voice": v => formatPercentNoDecimal(v),
      "BTS": v => formatPercentNoDecimal(v),
      "TFB": v => formatPercentNoDecimal(v),
      "VAF": v => formatDollar(v),
      "Accessories": v => formatPercentNoDecimal(v),
      "AAL Attainment": v => formatPercentNoDecimal(v),
      // Others: identity
    };

    // Formatting functions
    function formatDollarNoCents(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, "")); if (isNaN(n)) return "";
      return "$" + Math.round(n).toLocaleString();
    }
    function formatDollar(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, "")); if (isNaN(n)) return "";
      return "$" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function formatPercentNoDecimal(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, ""));
      if (isNaN(n)) return "";
      // if entered as 0-100, keep as is, if as 0-1, multiply by 100
      if (n <= 1 && n !== 0) n = n*100;
      return Math.round(n) + "%";
    }

    // Elements
    const locationSection = document.getElementById('locationSection');
    const locationForm = document.getElementById('locationForm');
    const locationDropdown = document.getElementById('locationDropdown');
    const weekSelect = document.getElementById('weekSelect');
    const metricsSection = document.getElementById('metricsSection');
    const metricsForm = document.getElementById('metricsForm');
    const formMetricsDiv = metricsForm.querySelector('.form-metrics');
    const editLocationBtn = document.getElementById('editLocation');
    const tableSection = document.getElementById('tableSection');
    const tableTitle = document.getElementById('tableTitle');
    const metricsTable = document.getElementById('metricsTable');
    const editMetricsBtn = document.getElementById('editMetrics');
    const clearAllDataBtn = document.getElementById('clearAllData');

    // State
    let locationName = "";
    let selectedWeek = "";
    let metricsData = {};
    let allData = {};

    // Local Storage keys
    const STORAGE_KEY = "locationPerformanceData";

    function loadAllData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      allData = raw ? JSON.parse(raw) : {};
    }

    function saveAllData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
    }

    // Location Form submission
    locationForm.onsubmit = function(e) {
      e.preventDefault();
      locationName = locationDropdown.value;
      selectedWeek = weekSelect.value;
      if(!locationName || !selectedWeek) return;

      loadAllData();
      let prevValues = (allData[locationName] && allData[locationName][selectedWeek]) || {};
      formMetricsDiv.innerHTML = metrics.map(metric =>
        `<label>${metric}: <input type="text" name="${metric}" required value="${prevValues[metric] || ""}" autocomplete="off" /></label>`
      ).join('');
      locationSection.classList.add('hidden');
      metricsSection.classList.remove('hidden');
      tableSection.classList.add('hidden');
    };

    editLocationBtn.onclick = function() {
      locationSection.classList.remove('hidden');
      metricsSection.classList.add('hidden');
      tableSection.classList.add('hidden');
      locationDropdown.value = locationName;
      weekSelect.value = selectedWeek;
    };

    metricsForm.onsubmit = function(e) {
      e.preventDefault();
      metricsData = {};
      metrics.forEach(metric => {
        let raw = metricsForm.elements[metric].value;
        metricsData[metric] = metricFormatters[metric]
          ? metricFormatters[metric](raw)
          : raw;
      });
      loadAllData();
      if (!allData[locationName]) allData[locationName] = {};
      allData[locationName][selectedWeek] = {...metricsData};
      saveAllData();
      renderTable();
    };

    function renderTable() {
      loadAllData();
      let locWeeks = allData[locationName] || {};
      tableTitle.textContent = `Location: ${locationName}`;
      metricsTable.innerHTML = metrics.map(metric => {
        let row = `<td>${metric}</td>`;
        for(let i=1; i<=5; i++) {
          row += `<td>${locWeeks[i] && locWeeks[i][metric] ? locWeeks[i][metric] : ""}</td>`;
        }
        return `<tr>${row}</tr>`;
      }).join('');
      tableSection.classList.remove('hidden');
      metricsForm.querySelector('.form-metrics').classList.add('hidden');
      metricsForm.querySelector('.actions').classList.add('hidden');
    }

    editMetricsBtn.onclick = function() {
      loadAllData();
      let prevValues = (allData[locationName] && allData[locationName][selectedWeek]) || {};
      metrics.forEach(metric => {
        metricsForm.elements[metric].value = prevValues[metric] || "";
      });
      tableSection.classList.add('hidden');
      metricsForm.querySelector('.form-metrics').classList.remove('hidden');
      metricsForm.querySelector('.actions').classList.remove('hidden');
    };

    // CHANGED: Now clears only data for the currently selected location
    clearAllDataBtn.onclick = function() {
      if (!locationName) {
        alert('Please select a location.');
        return;
      }
      if (window.confirm("Are you sure you want to clear ALL saved data for this location?")) {
        loadAllData();
        if (allData[locationName]) {
          delete allData[locationName];
          saveAllData();
        }
        // Reset UI to location page:
        locationSection.classList.remove('hidden');
        metricsSection.classList.add('hidden');
        tableSection.classList.add('hidden');
        locationDropdown.value = "";
        weekSelect.value = "";
      }
    };

    // On page load, just initialize
    loadAllData();

  </script>
</body>
</html>
