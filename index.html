<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Performance, Forms, Commitments</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --primary-bg: #f9f9f9;
      --primary-accent: #d32f2f;
      --primary-border: #d1d5db;
      --primary-radius: 8px;
      --primary-font: 'Segoe UI', Arial, sans-serif;
      --target-highlight: #fff59d;
      --target-entry-color: #d32f2f;
      --leaderboard-bg: #DC008C;
      --leaderboard-color: #111;
      --metric-grey: #ededed;
      --store-black: #111;
      --store-white: #fff;
      --white: #fff;
    }
    html, body {
      margin: 0;
      padding: 0;
      background: var(--primary-bg);
      font-family: var(--primary-font);
      color: #222;
      min-height: 100vh;
      box-sizing: border-box;
    }
    body {
      max-width: 570px;
      margin: 0 auto;
      padding: 1em 0.5em 3em 0.5em;
      box-sizing: border-box;
    }
    h1 {
      font-size: 1.3em;
      margin-bottom: 1em;
      text-align: center;
      color: var(--primary-accent);
      letter-spacing: 1px;
      font-weight: 700;
    }
    .section-title {
      font-size: 1.2em;
      font-weight: 700;
      text-align: center;
      margin: 0.6em 0 1.1em 0;
      background: var(--leaderboard-bg);
      color: var(--leaderboard-color);
      border-radius: var(--primary-radius);
      padding: 0.6em;
      letter-spacing: 1px;
    }
    form {
      background: #fff;
      padding: 1em 0.7em 1em 0.7em;
      border-radius: var(--primary-radius);
      box-shadow: 0 2px 8px 0 #0001;
      margin-bottom: 1em;
    }
    label {
      display: block;
      margin-top: 0.7em;
      font-weight: 500;
      font-size: 1em;
    }
    select, input[type="text"], button {
      font-size: 1em;
      width: 100%;
      padding: 0.6em;
      border: 1px solid var(--primary-border);
      border-radius: var(--primary-radius);
      box-sizing: border-box;
      margin-top: 0.4em;
      margin-bottom: 0.4em;
      background: #fcfcfc;
      transition: box-shadow 0.2s, border 0.2s;
    }
    select:focus, input[type="text"]:focus, .target-input:focus {
      outline: none;
      border: 1.5px solid var(--primary-accent);
      box-shadow: 0 0 3px 1.5px #d32f2f40;
    }
    button {
      background: var(--primary-accent);
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      margin-top: 1em;
      margin-bottom: 0;
      border: none;
      transition: background 0.2s;
      font-size: 1em;
      border-radius: var(--primary-radius);
    }
    button:hover, button:focus {
      background: #a62828;
    }
    .actions {
      display: flex;
      gap: 0.5em;
      margin-top: 1em;
      flex-wrap: wrap;
    }
    .actions > button {
      flex: 1;
      min-width: 90px;
      font-size: 0.98em;
    }
    .metric-row {
      margin-bottom: 1em;
    }
    .metric-label {
      font-weight: 600;
      font-size: 1em;
      margin-bottom: 0.2em;
      display: block;
    }
    .entry-row {
      display: flex;
      gap: 0.6em;
      margin-top: 0.1em;
    }
    .entry-col {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .entry-label {
      font-size: 0.97em;
      margin-bottom: 0.08em;
      font-weight: 400;
      color: #777;
    }
    .target-input {
      font-size: 1em;
      padding: 0.45em;
      border: 1.5px solid var(--primary-accent);
      border-radius: var(--primary-radius);
      background: #f3f3f3;
      color: var(--target-entry-color);
      font-weight: 500;
      box-sizing: border-box;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .current-input {
      font-size: 1em;
      padding: 0.45em;
      border: 1px solid var(--primary-border);
      border-radius: var(--primary-radius);
      background: #fcfcfc;
      color: #222;
      font-weight: 500;
      box-sizing: border-box;
      transition: border 0.2s, box-shadow 0.2s;
    }
    .reset-targets-btn {
      margin-top: 1.1em;
      margin-bottom: 0.3em;
      background: #757575;
      color: #fff;
      border: none;
      border-radius: var(--primary-radius);
      padding: 0.6em 1em;
      font-size: 0.97em;
      font-weight: 500;
      cursor: pointer;
      transition: background 0.2s;
      width: 100%;
      display: block;
    }
    .reset-targets-btn:hover, .reset-targets-btn:focus {
      background: #a62828;
    }
    #tableTitle {
      text-align: center;
      font-weight: 600;
      font-size: 1.1em;
      margin: 0.8em 0 0.2em 0;
      color: var(--primary-accent);
      letter-spacing: 0.6px;
    }
    #printMeta {
      text-align: center;
      margin-bottom: 8px;
      color: #444;
      font-size: 0.97em;
      word-break: break-word;
    }
    .table-container {
      width: 100%;
      overflow-x: auto;
      margin: 0 auto;
      background: #fff;
      border-radius: var(--primary-radius);
      box-shadow: 0 2px 8px 0 #0001;
      padding: 0.2em 0.2em;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 0.5em 0 0.8em 0;
      background: #fff;
      font-size: 0.97em;
      min-width: 530px;
      table-layout: fixed;
    }
    th, td {
      border: 1px solid var(--primary-border);
      padding: 0.45em 0.1em;
      text-align: center;
      vertical-align: middle;
      word-break: break-word;
      /* Ensures fixed width for all columns */
    }
    th {
      background: #ffebee;
      color: var(--primary-accent);
      font-size: 1em;
      font-weight: 700;
    }
    /* Metric name cells & pre-CS row */
    .metric-cell, .pre-cs-row td {
      background: var(--metric-grey) !important;
      color: #222 !important;
      font-weight: 600;
    }
    /* Store name cell */
    .store-cell {
      background: var(--store-black) !important;
      color: var(--store-white) !important;
      font-weight: 700 !important;
      letter-spacing: 0.7px;
      font-size: 1em;
    }
    .target-cell {
      background: var(--target-highlight) !important;
      font-weight: 700;
      color: var(--primary-accent) !important;
    }
    .leaderboard-row td {
      background: var(--leaderboard-bg) !important;
      color: var(--leaderboard-color) !important;
      font-weight: 700;
      font-size: 1.03em;
      letter-spacing: 1.5px;
      text-align: center;
      border: none !important;
      padding: 0.8em 0 !important;
    }
    /* Top merged row */
    .top-title-row td {
      background: var(--leaderboard-bg) !important;
      color: var(--leaderboard-color) !important;
      font-weight: 700;
      font-size: 2.4em !important;
      letter-spacing: 1.5px;
      text-align: center;
      border: none !important;
      padding: 1em 0 !important;
      border-radius: var(--primary-radius) var(--primary-radius) 0 0;
    }
    /* Merged white row above CS Leaderboard */
    .pre-cs-row td {
      background: var(--white) !important;
      color: #222 !important;
      border: none !important;
      font-size: 1em;
      padding: 0.6em 0 !important;
    }
    /* Set width for columns 2-7 */
    th:not(:first-child), td:not(:first-child) {
      width: 110px;
      max-width: 110px;
      min-width: 110px;
    }
    .store-cell {
      width: auto !important;
      min-width: 90px !important;
      max-width: 180px !important;
    }
    @media (max-width: 700px) {
      body {
        padding: 0.2em 0.05em 2em 0.05em;
      }
      .entry-row {
        flex-direction: column;
        gap: 0.3em;
      }
      table, thead, tbody, th, td, tr {
        display: block;
      }
      table {
        font-size: 1em;
        min-width: 0;
      }
      thead {
        display: none;
      }
      tr {
        margin-bottom: 1em;
        background: #fff;
        box-shadow: 0 1px 4px 0 #0001;
        border-radius: var(--primary-radius);
      }
      td {
        border: none;
        border-bottom: 1px solid #eee;
        position: relative;
        padding-left: 45%;
        text-align: left;
        min-height: 30px;
      }
      td:before {
        position: absolute;
        top: 0;
        left: 0;
        width: 44%;
        padding-left: 0.5em;
        font-weight: 600;
        white-space: pre-wrap;
        color: #555;
      }
      tr td:first-child {
        background: var(--metric-grey) !important;
        border-radius: var(--primary-radius) var(--primary-radius) 0 0;
        font-weight: 700;
        padding-left: 1em;
        color: #222 !important;
        font-size: 1em;
      }
      .leaderboard-row td {
        padding-left: 0 !important;
        text-align: center !important;
        font-size: 1em !important;
      }
      .store-cell {
        background: var(--store-black) !important;
        color: var(--store-white) !important;
      }
    }
    @media (max-width: 430px) {
      form, table {
        border-radius: 0;
        box-shadow: none;
      }
      .actions > button {
        font-size: 0.93em;
        min-width: 0;
      }
      #tableTitle {
        font-size: 0.97em;
      }
    }
    @media print {
      body {
        background: #fff;
        color: #000;
        max-width: none;
        padding: 0;
      }
      h1, #metricsSection, #gapsSection, #formsSection, .actions, .form-metrics, .form-gaps, .form-forms, #backToMetrics, #clearAllData, #printTableBtn, #selectionSection, #metricsForm, #gapsForm, #formsForm, button, .actions, .hidden, .reset-targets-btn {
        display: none !important;
      }
      #tableSection, #tableTitle, #printMeta, .table-container, table, thead, tbody, tr, th, td {
        display: block !important;
        color: #000;
      }
      #tableSection {
        margin: 0;
        padding: 0;
      }
      #tableTitle, #printMeta {
        margin-top: 0;
        margin-bottom: 4px;
        font-size: 1.1em;
        color: #000 !important;
      }
      table {
        font-size: 0.92em;
        margin-top: 0.2em;
        border-radius: 0;
        box-shadow: none;
        width: 100%;
      }
      th, td {
        color: #000 !important;
        border: 1px solid #999 !important;
        background: #fff !important;
        padding: 0.3em 0.06em;
      }
      th {
        color: #000 !important;
        background: #eee !important;
      }
      .leaderboard-row td {
        background: #DC008C !important;
        color: #111 !important;
        border: none !important;
        font-weight: 700 !important;
        font-size: 1.03em !important;
        letter-spacing: 1.5px !important;
        text-align: center !important;
        padding: 0.7em 0 !important;
      }
      .metric-cell, .pre-cs-row td {
        background: #ededed !important;
        color: #222 !important;
        font-weight: 600 !important;
      }
      .store-cell {
        background: #111 !important;
        color: #fff !important;
        font-weight: 700 !important;
        letter-spacing: 0.7px !important;
      }
      .top-title-row td {
        background: #DC008C !important;
        color: #111 !important;
        font-weight: 700 !important;
        font-size: 2.4em !important;
      }
      @page {
        size: portrait;
        margin: 0.45in 0.18in 0.45in 0.18in;
      }
    }
  </style>
  <script src="hierarchy.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
</head>
<body>
  <h1>Weekly Business Review</h1>
  <!-- Selection Page -->
  <div id="selectionSection">
    <form id="selectionForm" autocomplete="off">
      <label>Area:
        <select id="areaDropdown" required>
          <option value="">--Select Area--</option>
        </select>
      </label>
      <label>Region:
        <select id="regionDropdown" required disabled>
          <option value="">--Select Region--</option>
        </select>
      </label>
      <label>District:
        <select id="districtDropdown" required disabled>
          <option value="">--Select District--</option>
        </select>
      </label>
      <label>Store:
        <select id="storeDropdown" required disabled>
          <option value="">--Select Store--</option>
        </select>
      </label>
      <label>Select Week: 
        <select id="weekSelect" required>
          <option value="">--Select Week--</option>
          <option value="1">Week 1</option>
          <option value="2">Week 2</option>
          <option value="3">Week 3</option>
          <option value="4">Week 4</option>
          <option value="5">Week 5</option>
        </select>
      </label>
      <div class="actions">
        <button type="submit" id="nextToMetrics">Next</button>
      </div>
    </form>
  </div>

  <!-- CS Leaderboard Data Entry Page -->
  <div id="metricsSection" class="hidden">
    <div class="section-title">CS Leaderboard</div>
    <form id="metricsForm" autocomplete="off">
      <div class="form-metrics"></div>
      <button type="button" class="reset-targets-btn" id="resetTargetsBtn">Reset Targets to Default</button>
      <div class="actions">
        <button type="button" id="backButton">Back</button>
        <button type="button" id="nextToGapsBtn">Next</button>
      </div>
    </form>
  </div>

  <!-- Current Gaps Data Entry Page -->
  <div id="gapsSection" class="hidden">
    <div class="section-title">Current Gaps</div>
    <form id="gapsForm" autocomplete="off">
      <div class="form-gaps"></div>
      <button type="button" class="reset-targets-btn" id="resetGapsTargetsBtn">Reset Targets to Default</button>
      <div class="actions">
        <button type="button" id="backToLeaderboardBtn">Back</button>
        <button type="button" id="nextToFormsBtn">Next</button>
      </div>
    </form>
  </div>

  <!-- Form Usage Data Entry Page -->
  <div id="formsSection" class="hidden">
    <div class="section-title">Form Usage (previous week)</div>
    <form id="formsForm" autocomplete="off">
      <div class="form-forms"></div>
      <button type="button" class="reset-targets-btn" id="resetFormsTargetsBtn">Reset Targets to Default</button>
      <div class="actions">
        <button type="button" id="backToGapsBtn">Back</button>
        <button type="submit" id="nextBtnForms">Next</button>
      </div>
    </form>
  </div>

  <!-- Data Table Page -->
  <div id="tableSection" class="hidden">
    <div id="printMeta"></div>
    <h2 id="tableTitle"></h2>
    <div class="table-container" id="tableWrapper">
      <table id="mainMetricsTable">
        <thead>
          <tr class="top-title-row">
            <td colspan="7">Performance & Forms</td>
          </tr>
          <tr class="pre-cs-row">
            <td colspan="7"></td>
          </tr>
          <tr class="header-row" id="metricsHeaderRow"></tr>
          <tr class="leaderboard-row" id="leaderboardRow"></tr>
        </thead>
        <tbody id="metricsTable"></tbody>
        <tbody id="gapsTable"></tbody>
        <tbody id="formsTable"></tbody>
      </table>
    </div>
    <div class="actions" id="tableActions">
      <button id="backToMetrics">Back</button>
      <button id="clearAllData">Clear All Data</button>
      <button id="printTableBtn" type="button">Print</button>
    </div>
  </div>

  <script>
    // CS Leaderboard metrics and targets
    const metrics = [
      "Net Trending GP", "Current Rank", "Current Quintile", "Bottom Metrics",
      "GP % Target", "GP per HR", "Voice", "BTS", "TFB", "VAF",
      "Accessories", "CSAT", "AAL Attainment"
    ];
    const metricFormatters = {
      "Net Trending GP": v => formatDollarNoCents(v),
      "GP % Target": v => formatPercentNoDecimal(v),
      "GP per HR": v => formatDollar(v),
      "Voice": v => formatPercentNoDecimal(v),
      "BTS": v => formatPercentNoDecimal(v),
      "TFB": v => formatPercentNoDecimal(v),
      "VAF": v => formatDollar(v),
      "Accessories": v => formatPercentNoDecimal(v),
      "AAL Attainment": v => formatPercentNoDecimal(v),
      "Current Rank": v => v,
      "Current Quintile": v => v,
      "Bottom Metrics": v => v,
      "CSAT": v => v
    };
    const defaultTargets = {
      "Net Trending GP": "",
      "Current Rank": "86",
      "Current Quintile": "1",
      "Bottom Metrics": "4th/5th",
      "GP % Target": "125%",
      "GP per HR": "$35",
      "Voice": "125%",
      "BTS": "125%",
      "TFB": "125%",
      "VAF": "$19",
      "Accessories": "125%",
      "CSAT": "9.5",
      "AAL Attainment": "100%"
    };

    // Current Gaps metrics and targets
    const gapsMetrics = [
      "Voice", "BTS", "TFB", "VAF", "Accessory Qty"
    ];
    const gapsCellTableFormatters = {
      "Voice": v => formatInteger(v),
      "BTS": v => formatInteger(v),
      "TFB": v => formatInteger(v),
      "VAF": v => formatDollarNoCents(v),
      "Accessory Qty": v => formatDollarNoCents(v)
    };
    const gapsFormatters = {
      "Voice": v => v,
      "BTS": v => v,
      "TFB": v => v,
      "VAF": v => v,
      "Accessory Qty": v => v
    };
    const defaultGapsTargets = {
      "Voice": "125%",
      "BTS": "125%",
      "TFB": "125%",
      "VAF": "$19",
      "Accessory Qty": "125%"
    };

    // Form Usage metrics and targets
    const formsMetrics = [
      "Pre-Connects", "Pay Connects", "CSWays", "Social Media", "Meeting Minutes", "Paylocity Entries"
    ];
    const formsFormatters = {
      "Pre-Connects": v => v,
      "Pay Connects": v => v,
      "CSWays": v => v,
      "Social Media": v => v,
      "Meeting Minutes": v => v,
      "Paylocity Entries": v => v
    };
    const defaultFormsTargets = {
      "Pre-Connects": "1 - rep/day",
      "Pay Connects": "1 - rep/week",
      "CSWays": "2 per day",
      "Social Media": "1 per 100",
      "Meeting Minutes": "1 weekly",
      "Paylocity Entries": "if needed"
    };

    function formatDollarNoCents(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, "")); if (isNaN(n)) return "";
      return "$" + Math.round(n).toLocaleString();
    }
    function formatDollar(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, "")); if (isNaN(n)) return "";
      return "$" + n.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function formatPercentNoDecimal(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, ""));
      if (isNaN(n)) return "";
      if (n <= 1 && n !== 0) n = n*100;
      return Math.round(n) + "%";
    }
    function formatInteger(val) {
      let n = parseFloat(val.replace(/[^0-9.\-]/g, ""));
      if (isNaN(n)) return "";
      return Math.round(n).toString();
    }

    // Elements
    const selectionSection = document.getElementById('selectionSection');
    const selectionForm = document.getElementById('selectionForm');
    const areaDropdown = document.getElementById('areaDropdown');
    const regionDropdown = document.getElementById('regionDropdown');
    const districtDropdown = document.getElementById('districtDropdown');
    const storeDropdown = document.getElementById('storeDropdown');
    const weekSelect = document.getElementById('weekSelect');

    // CS Leaderboard section
    const metricsSection = document.getElementById('metricsSection');
    const metricsForm = document.getElementById('metricsForm');
    const formMetricsDiv = metricsForm.querySelector('.form-metrics');
    const resetTargetsBtn = document.getElementById('resetTargetsBtn');
    const backButton = document.getElementById('backButton');
    const nextToGapsBtn = document.getElementById('nextToGapsBtn');

    // Current Gaps section
    const gapsSection = document.getElementById('gapsSection');
    const gapsForm = document.getElementById('gapsForm');
    const formGapsDiv = gapsForm.querySelector('.form-gaps');
    const resetGapsTargetsBtn = document.getElementById('resetGapsTargetsBtn');
    const backToLeaderboardBtn = document.getElementById('backToLeaderboardBtn');
    const nextToFormsBtn = document.getElementById('nextToFormsBtn');

    // Forms Usage section
    const formsSection = document.getElementById('formsSection');
    const formsForm = document.getElementById('formsForm');
    const formFormsDiv = formsForm.querySelector('.form-forms');
    const resetFormsTargetsBtn = document.getElementById('resetFormsTargetsBtn');
    const backToGapsBtn = document.getElementById('backToGapsBtn');
    const nextBtnForms = document.getElementById('nextBtnForms');

    // Table section
    const tableSection = document.getElementById('tableSection');
    const tableTitle = document.getElementById('tableTitle');
    const printMeta = document.getElementById('printMeta');
    const mainMetricsTable = document.getElementById('mainMetricsTable');
    const metricsHeaderRow = document.getElementById('metricsHeaderRow');
    const leaderboardRow = document.getElementById('leaderboardRow');
    const preCSRow = mainMetricsTable.querySelector('.pre-cs-row');
    const topTitleRow = mainMetricsTable.querySelector('.top-title-row');
    const metricsTable = document.getElementById('metricsTable');
    const gapsTable = document.getElementById('gapsTable');
    const formsTable = document.getElementById('formsTable');
    const backToMetricsBtn = document.getElementById('backToMetrics');
    const clearAllDataBtn = document.getElementById('clearAllData');
    const printTableBtn = document.getElementById('printTableBtn');
    const tableWrapper = document.getElementById('tableWrapper');

    // State
    let selectedArea = "";
    let selectedRegion = "";
    let selectedDistrict = "";
    let selectedStore = "";
    let selectedWeek = "";
    let metricsData = {};
    let allData = {};
    let storeTargets = {};
    let gapsData = {};
    let allGapsData = {};
    let gapsTargets = {};
    let formsData = {};
    let allFormsData = {};
    let formsTargets = {};
    const STORAGE_KEY = "locationPerformanceData";
    const TARGETS_KEY = "locationTargetData";
    const GAPS_STORAGE_KEY = "locationGapsData";
    const GAPS_TARGETS_KEY = "locationGapsTargetData";
    const FORMS_STORAGE_KEY = "locationFormsData";
    const FORMS_TARGETS_KEY = "locationFormsTargetData";

    function getStoreTargetKey(store) {
      return store ? store : "default";
    }
    // Leaderboard
    function loadTargets(store) {
      let raw = localStorage.getItem(TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      return allTargets[getStoreTargetKey(store)] || {...defaultTargets};
    }
    function saveTargets(store, targets) {
      let raw = localStorage.getItem(TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      allTargets[getStoreTargetKey(store)] = {...targets};
      localStorage.setItem(TARGETS_KEY, JSON.stringify(allTargets));
    }
    function resetStoreTargets(store) {
      saveTargets(store, {...defaultTargets});
    }
    // Gaps
    function loadGapsTargets(store) {
      let raw = localStorage.getItem(GAPS_TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      return allTargets[getStoreTargetKey(store)] || {...defaultGapsTargets};
    }
    function saveGapsTargets(store, targets) {
      let raw = localStorage.getItem(GAPS_TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      allTargets[getStoreTargetKey(store)] = {...targets};
      localStorage.setItem(GAPS_TARGETS_KEY, JSON.stringify(allTargets));
    }
    function resetStoreGapsTargets(store) {
      saveGapsTargets(store, {...defaultGapsTargets});
    }
    // Forms
    function loadFormsTargets(store) {
      let raw = localStorage.getItem(FORMS_TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      return allTargets[getStoreTargetKey(store)] || {...defaultFormsTargets};
    }
    function saveFormsTargets(store, targets) {
      let raw = localStorage.getItem(FORMS_TARGETS_KEY);
      let allTargets = raw ? JSON.parse(raw) : {};
      allTargets[getStoreTargetKey(store)] = {...targets};
      localStorage.setItem(FORMS_TARGETS_KEY, JSON.stringify(allTargets));
    }
    function resetStoreFormsTargets(store) {
      saveFormsTargets(store, {...defaultFormsTargets});
    }

    function loadAllData() {
      const raw = localStorage.getItem(STORAGE_KEY);
      allData = raw ? JSON.parse(raw) : {};
    }
    function saveAllData() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(allData));
    }
    function loadAllGapsData() {
      const raw = localStorage.getItem(GAPS_STORAGE_KEY);
      allGapsData = raw ? JSON.parse(raw) : {};
    }
    function saveAllGapsData() {
      localStorage.setItem(GAPS_STORAGE_KEY, JSON.stringify(allGapsData));
    }
    function loadAllFormsData() {
      const raw = localStorage.getItem(FORMS_STORAGE_KEY);
      allFormsData = raw ? JSON.parse(raw) : {};
    }
    function saveAllFormsData() {
      localStorage.setItem(FORMS_STORAGE_KEY, JSON.stringify(allFormsData));
    }

    function populateAreaDropdown() {
      areaDropdown.innerHTML = '<option value="">--Select Area--</option>';
      Object.keys(hierarchy).sort().forEach(area => {
        areaDropdown.innerHTML += `<option value="${area}">${area}</option>`;
      });
      regionDropdown.disabled = true;
      districtDropdown.disabled = true;
      storeDropdown.disabled = true;
      regionDropdown.innerHTML = '<option value="">--Select Region--</option>';
      districtDropdown.innerHTML = '<option value="">--Select District--</option>';
      storeDropdown.innerHTML = '<option value="">--Select Store--</option>';
    }

    areaDropdown.addEventListener('change', function() {
      selectedArea = this.value;
      regionDropdown.disabled = !selectedArea;
      districtDropdown.disabled = true;
      storeDropdown.disabled = true;
      regionDropdown.innerHTML = '<option value="">--Select Region--</option>';
      districtDropdown.innerHTML = '<option value="">--Select District--</option>';
      storeDropdown.innerHTML = '<option value="">--Select Store--</option>';
      if (!selectedArea) return;
      Object.keys(hierarchy[selectedArea]).sort().forEach(region => {
        regionDropdown.innerHTML += `<option value="${region}">${region}</option>`;
      });
    });

    regionDropdown.addEventListener('change', function() {
      selectedRegion = this.value;
      districtDropdown.disabled = !selectedRegion;
      storeDropdown.disabled = true;
      districtDropdown.innerHTML = '<option value="">--Select District--</option>';
      storeDropdown.innerHTML = '<option value="">--Select Store--</option>';
      if (!selectedRegion) return;
      Object.keys(hierarchy[selectedArea][selectedRegion]).sort().forEach(district => {
        districtDropdown.innerHTML += `<option value="${district}">${district}</option>`;
      });
    });

    districtDropdown.addEventListener('change', function() {
      selectedDistrict = this.value;
      storeDropdown.disabled = !selectedDistrict;
      storeDropdown.innerHTML = '<option value="">--Select Store--</option>';
      if (!selectedDistrict) return;
      hierarchy[selectedArea][selectedRegion][selectedDistrict].sort().forEach(store => {
        storeDropdown.innerHTML += `<option value="${store}">${store}</option>`;
      });
    });

    storeDropdown.addEventListener('change', function() {
      selectedStore = this.value;
    });

    // --- Section 1: Leaderboard ---
    selectionForm.onsubmit = function(e) {
      e.preventDefault();
      selectedArea = areaDropdown.value;
      selectedRegion = regionDropdown.value;
      selectedDistrict = districtDropdown.value;
      selectedStore = storeDropdown.value;
      selectedWeek = weekSelect.value;
      if (!selectedArea || !selectedRegion || !selectedDistrict || !selectedStore || !selectedWeek) return;
      loadAllData();
      storeTargets = loadTargets(selectedStore);

      let prevValues = (allData[selectedStore] && allData[selectedStore][selectedWeek]) || {};
      formMetricsDiv.innerHTML = metrics.map(metric => `
        <div class="metric-row">
          <span class="metric-label">${metric}:</span>
          <div class="entry-row">
            <div class="entry-col">
              <span class="entry-label">Target</span>
              <input class="target-input" type="text" name="target_${metric}" value="${storeTargets[metric] || defaultTargets[metric] || ""}" autocomplete="off" />
            </div>
            <div class="entry-col">
              <span class="entry-label">Current</span>
              <input class="current-input" type="text" name="${metric}" required value="${prevValues[metric] || ""}" autocomplete="off" />
            </div>
          </div>
        </div>
      `).join('');
      selectionSection.classList.add('hidden');
      metricsSection.classList.remove('hidden');
      gapsSection.classList.add('hidden');
      formsSection.classList.add('hidden');
      tableSection.classList.add('hidden');
    };

    metricsForm.onsubmit = function(e) {
      e.preventDefault();
    };
    nextToGapsBtn.onclick = function() {
      metricsData = {};
      let newTargets = {};
      metrics.forEach(metric => {
        let raw = metricsForm.elements[metric].value;
        metricsData[metric] = metricFormatters[metric]
          ? metricFormatters[metric](raw)
          : raw;
        let targetRaw = metricsForm.elements["target_" + metric].value;
        newTargets[metric] = targetRaw;
      });
      loadAllData();
      if (!allData[selectedStore]) allData[selectedStore] = {};
      allData[selectedStore][selectedWeek] = {...metricsData};
      saveAllData();
      saveTargets(selectedStore, newTargets);
      storeTargets = {...newTargets};

      // Section 2: Current Gaps
      loadAllGapsData();
      gapsTargets = loadGapsTargets(selectedStore);
      let prevGapsValues = (allGapsData[selectedStore] && allGapsData[selectedStore][selectedWeek]) || {};
      formGapsDiv.innerHTML = gapsMetrics.map(metric => `
        <div class="metric-row">
          <span class="metric-label">${metric}:</span>
          <div class="entry-row">
            <div class="entry-col">
              <span class="entry-label">Target</span>
              <input class="target-input" type="text" name="target_gaps_${metric}" value="${gapsTargets[metric] || defaultGapsTargets[metric] || ""}" autocomplete="off" />
            </div>
            <div class="entry-col">
              <span class="entry-label">Current</span>
              <input class="current-input" type="text" name="gaps_${metric}" required value="${prevGapsValues[metric] || ""}" autocomplete="off" />
            </div>
          </div>
        </div>
      `).join('');
      metricsSection.classList.add('hidden');
      gapsSection.classList.remove('hidden');
      formsSection.classList.add('hidden');
      tableSection.classList.add('hidden');
    };

    // --- Section 2: Current Gaps ---
    gapsForm.onsubmit = function(e) {
      e.preventDefault();
    };
    nextToFormsBtn.onclick = function() {
      gapsData = {};
      let newGapsTargets = {};
      gapsMetrics.forEach(metric => {
        let raw = gapsForm.elements["gaps_" + metric].value;
        gapsData[metric] = gapsFormatters[metric]
          ? gapsFormatters[metric](raw)
          : raw;
        let targetRaw = gapsForm.elements["target_gaps_" + metric].value;
        newGapsTargets[metric] = targetRaw;
      });
      loadAllGapsData();
      if (!allGapsData[selectedStore]) allGapsData[selectedStore] = {};
      allGapsData[selectedStore][selectedWeek] = {...gapsData};
      saveAllGapsData();
      saveGapsTargets(selectedStore, newGapsTargets);
      gapsTargets = {...newGapsTargets};

      // Section 3: Form Usage
      loadAllFormsData();
      formsTargets = loadFormsTargets(selectedStore);
      let prevFormsValues = (allFormsData[selectedStore] && allFormsData[selectedStore][selectedWeek]) || {};
      formFormsDiv.innerHTML = formsMetrics.map(metric => `
        <div class="metric-row">
          <span class="metric-label">${metric}:</span>
          <div class="entry-row">
            <div class="entry-col">
              <span class="entry-label">Target</span>
              <input class="target-input" type="text" name="target_forms_${metric}" value="${formsTargets[metric] || defaultFormsTargets[metric] || ""}" autocomplete="off" />
            </div>
            <div class="entry-col">
              <span class="entry-label">Current</span>
              <input class="current-input" type="text" name="forms_${metric}" required value="${prevFormsValues[metric] || ""}" autocomplete="off" />
            </div>
          </div>
        </div>
      `).join('');
      gapsSection.classList.add('hidden');
      formsSection.classList.remove('hidden');
      tableSection.classList.add('hidden');
      metricsSection.classList.add('hidden');
    };

    // --- Section 3: Form Usage ---
    formsForm.onsubmit = function(e) {
      e.preventDefault();
      formsData = {};
      let newFormsTargets = {};
      formsMetrics.forEach(metric => {
        let raw = formsForm.elements["forms_" + metric].value;
        formsData[metric] = formsFormatters[metric]
          ? formsFormatters[metric](raw)
          : raw;
        let targetRaw = formsForm.elements["target_forms_" + metric].value;
        newFormsTargets[metric] = targetRaw;
      });
      loadAllFormsData();
      if (!allFormsData[selectedStore]) allFormsData[selectedStore] = {};
      allFormsData[selectedStore][selectedWeek] = {...formsData};
      saveAllFormsData();
      saveFormsTargets(selectedStore, newFormsTargets);
      formsTargets = {...newFormsTargets};
      renderTable();
    };

    // --- Reset buttons ---
    resetTargetsBtn.onclick = function() {
      if (!selectedStore) return;
      resetStoreTargets(selectedStore);
      storeTargets = loadTargets(selectedStore);
      metrics.forEach(metric => {
        if (metricsForm.elements["target_" + metric]) {
          metricsForm.elements["target_" + metric].value = defaultTargets[metric] || "";
        }
      });
    };

    resetGapsTargetsBtn.onclick = function() {
      if (!selectedStore) return;
      resetStoreGapsTargets(selectedStore);
      gapsTargets = loadGapsTargets(selectedStore);
      gapsMetrics.forEach(metric => {
        if (gapsForm.elements["target_gaps_" + metric]) {
          gapsForm.elements["target_gaps_" + metric].value = defaultGapsTargets[metric] || "";
        }
      });
    };

    resetFormsTargetsBtn.onclick = function() {
      if (!selectedStore) return;
      resetStoreFormsTargets(selectedStore);
      formsTargets = loadFormsTargets(selectedStore);
      formsMetrics.forEach(metric => {
        if (formsForm.elements["target_forms_" + metric]) {
          formsForm.elements["target_forms_" + metric].value = defaultFormsTargets[metric] || "";
        }
      });
    };

    backButton.onclick = function() {
      selectionSection.classList.remove('hidden');
      metricsSection.classList.add('hidden');
      gapsSection.classList.add('hidden');
      formsSection.classList.add('hidden');
      tableSection.classList.add('hidden');
      areaDropdown.value = selectedArea;
      areaDropdown.dispatchEvent(new Event('change'));
      regionDropdown.value = selectedRegion;
      regionDropdown.dispatchEvent(new Event('change'));
      districtDropdown.value = selectedDistrict;
      districtDropdown.dispatchEvent(new Event('change'));
      storeDropdown.value = selectedStore;
      weekSelect.value = selectedWeek;
    };

    backToLeaderboardBtn.onclick = function() {
      loadAllData();
      storeTargets = loadTargets(selectedStore);
      let prevValues = (allData[selectedStore] && allData[selectedStore][selectedWeek]) || {};
      metrics.forEach(metric => {
        metricsForm.elements[metric].value = prevValues[metric] || "";
        metricsForm.elements["target_" + metric].value = storeTargets[metric] || defaultTargets[metric] || "";
      });
      gapsSection.classList.add('hidden');
      metricsSection.classList.remove('hidden');
      selectionSection.classList.add('hidden');
      tableSection.classList.add('hidden');
      formsSection.classList.add('hidden');
    };

    backToGapsBtn.onclick = function() {
      loadAllGapsData();
      gapsTargets = loadGapsTargets(selectedStore);
      let prevGapsValues = (allGapsData[selectedStore] && allGapsData[selectedStore][selectedWeek]) || {};
      gapsMetrics.forEach(metric => {
        gapsForm.elements["gaps_" + metric].value = prevGapsValues[metric] || "";
        gapsForm.elements["target_gaps_" + metric].value = gapsTargets[metric] || defaultGapsTargets[metric] || "";
      });
      formsSection.classList.add('hidden');
      gapsSection.classList.remove('hidden');
      metricsSection.classList.add('hidden');
      selectionSection.classList.add('hidden');
      tableSection.classList.add('hidden');
    };

    backToMetricsBtn.onclick = function() {
      loadAllFormsData();
      formsTargets = loadFormsTargets(selectedStore);
      let prevFormsValues = (allFormsData[selectedStore] && allFormsData[selectedStore][selectedWeek]) || {};
      formsMetrics.forEach(metric => {
        formsForm.elements["forms_" + metric].value = prevFormsValues[metric] || "";
        formsForm.elements["target_forms_" + metric].value = formsTargets[metric] || defaultFormsTargets[metric] || "";
      });
      tableSection.classList.add('hidden');
      formsSection.classList.remove('hidden');
      gapsSection.classList.add('hidden');
      metricsSection.classList.add('hidden');
      selectionSection.classList.add('hidden');
    };

    clearAllDataBtn.onclick = function() {
      if (!selectedStore) {
        alert('Please select a store.');
        return;
      }
      if (window.confirm("Are you sure you want to clear ALL saved data for this store?")) {
        loadAllData();
        if (allData[selectedStore]) {
          delete allData[selectedStore];
          saveAllData();
        }
        let raw = localStorage.getItem(TARGETS_KEY);
        let allTargets = raw ? JSON.parse(raw) : {};
        delete allTargets[getStoreTargetKey(selectedStore)];
        localStorage.setItem(TARGETS_KEY, JSON.stringify(allTargets));

        loadAllGapsData();
        if (allGapsData[selectedStore]) {
          delete allGapsData[selectedStore];
          saveAllGapsData();
        }
        let rawGaps = localStorage.getItem(GAPS_TARGETS_KEY);
        let allGapsTargets = rawGaps ? JSON.parse(rawGaps) : {};
        delete allGapsTargets[getStoreTargetKey(selectedStore)];
        localStorage.setItem(GAPS_TARGETS_KEY, JSON.stringify(allGapsTargets));

        loadAllFormsData();
        if (allFormsData[selectedStore]) {
          delete allFormsData[selectedStore];
          saveAllFormsData();
        }
        let rawForms = localStorage.getItem(FORMS_TARGETS_KEY);
        let allFormsTargets = rawForms ? JSON.parse(rawForms) : {};
        delete allFormsTargets[getStoreTargetKey(selectedStore)];
        localStorage.setItem(FORMS_TARGETS_KEY, JSON.stringify(allFormsTargets));

        selectionSection.classList.remove('hidden');
        metricsSection.classList.add('hidden');
        gapsSection.classList.add('hidden');
        formsSection.classList.add('hidden');
        tableSection.classList.add('hidden');
        areaDropdown.value = "";
        regionDropdown.innerHTML = '<option value="">--Select Region--</option>';
        districtDropdown.innerHTML = '<option value="">--Select District--</option>';
        storeDropdown.innerHTML = '<option value="">--Select Store--</option>';
        regionDropdown.disabled = true;
        districtDropdown.disabled = true;
        storeDropdown.disabled = true;
        weekSelect.value = "";
      }
    };

    printTableBtn.onclick = function() {
      tableWrapper.style.maxWidth = "900px";
      tableWrapper.style.margin = "0 auto";
      html2canvas(tableSection, {
        scale: 2,
        backgroundColor: "#fff",
        useCORS: true,
        scrollX: 0,
        scrollY: 0,
        windowWidth: tableSection.scrollWidth,
        windowHeight: tableSection.scrollHeight,
      }).then(function(canvas) {
        tableWrapper.style.maxWidth = "";
        tableWrapper.style.margin = "";
        let win = window.open('', '_blank');
        win.document.write(`
          <html>
          <head>
            <title>Print Table</title>
            <style>
              html, body {
                margin: 0;
                padding: 0;
                background: #fff;
                width: 100vw;
                height: 100vh;
              }
              .centered-print {
                display: flex;
                align-items: center;
                justify-content: center;
                width: 100vw;
                height: 100vh;
                box-sizing: border-box;
              }
              canvas {
                display: block;
                max-width: 100vw;
                max-height: 100vh;
                width: auto !important;
                height: auto !important;
                background: #fff;
                margin: auto;
              }
              @media print {
                html, body { background: #fff !important; }
                .centered-print { width: 100vw; height: 100vh; }
                canvas { 
                  max-width: 95vw !important;
                  max-height: 95vh !important;
                  width: auto !important;
                  height: auto !important;
                  margin: auto !important;
                  display: block !important;
                  background: #fff !important;
                }
                body { margin: 0 !important; }
              }
            </style>
          </head>
          <body>
            <div class="centered-print" id="canvasContainer"></div>
          </body>
          </html>
        `);
        win.document.close();
        win.onload = function() {
          win.document.getElementById('canvasContainer').appendChild(canvas);
          setTimeout(() => {
            win.print();
          }, 400);
        };
      });
    };

    function renderTable() {
      loadAllData();
      storeTargets = loadTargets(selectedStore);
      let locWeeks = allData[selectedStore] || {};
      loadAllGapsData();
      gapsTargets = loadGapsTargets(selectedStore);
      let locGapsWeeks = allGapsData[selectedStore] || {};
      loadAllFormsData();
      formsTargets = loadFormsTargets(selectedStore);
      let locFormsWeeks = allFormsData[selectedStore] || {};

      tableTitle.textContent = `Store: ${selectedStore}`;
      let now = new Date();
      let dtStr = now.toLocaleString(undefined, {
        year: 'numeric', month: 'short', day: '2-digit',
        hour: '2-digit', minute: '2-digit'
      });
      printMeta.textContent = `Area: ${selectedArea} | Region: ${selectedRegion} | District: ${selectedDistrict} | Store: ${selectedStore} | Printed: ${dtStr}`;

      // Top merged row
      topTitleRow.innerHTML = `<td colspan="7">Performance & Forms</td>`;
      // Pre-CS row (white fill, merged)
      preCSRow.innerHTML = `<td colspan="7"></td>`;

      // Table headers, first column is store name
      let headerHTML = `
        <th class="store-cell">${selectedStore ? selectedStore : "Metric"}</th>
        <th>Target</th>
        <th>Week 1</th>
        <th>Week 2</th>
        <th>Week 3</th>
        <th>Week 4</th>
        <th>Week 5</th>
      `;
      metricsHeaderRow.innerHTML = headerHTML;
      leaderboardRow.innerHTML = `<td colspan="7" style="background:#DC008C;color:#111;font-weight:700;font-size:1.03em;letter-spacing:1.5px;text-align:center;border:none;">CS Leaderboard</td>`;

      // CS Leaderboard table body
      metricsTable.innerHTML = metrics.map(metric => {
        let row = `<td class="metric-cell">${metric}</td>`;
        row += `<td class="target-cell">${storeTargets[metric] || defaultTargets[metric] || ""}</td>`;
        for(let i=1; i<=5; i++) {
          row += `<td>${locWeeks[i] && locWeeks[i][metric] ? locWeeks[i][metric] : ""}</td>`;
        }
        return `<tr>${row}</tr>`;
      }).join('');
      // Current Gaps table body with section row
      let gapsSectionRow = `<tr class="leaderboard-row"><td colspan="7">Current Gaps</td></tr>`;
      let gapsRows = gapsMetrics.map(metric => {
        let row = `<td class="metric-cell">${metric}</td>`;
        row += `<td class="target-cell">${gapsTargets[metric] || defaultGapsTargets[metric] || ""}</td>`;
        for(let i=1; i<=5; i++) {
          let cellValue = locGapsWeeks[i] && locGapsWeeks[i][metric] ? locGapsWeeks[i][metric] : "";
          if (cellValue !== "") {
            row += `<td>${gapsCellTableFormatters[metric] ? gapsCellTableFormatters[metric](cellValue) : cellValue}</td>`;
          } else {
            row += `<td></td>`;
          }
        }
        return `<tr>${row}</tr>`;
      }).join('');
      gapsTable.innerHTML = gapsSectionRow + gapsRows;

      // Form Usage table body with section row
      let formsSectionRow = `<tr class="leaderboard-row"><td colspan="7">Form Usage (previous week)</td></tr>`;
      let formsRows = formsMetrics.map(metric => {
        let row = `<td class="metric-cell">${metric}</td>`;
        row += `<td class="target-cell">${formsTargets[metric] || defaultFormsTargets[metric] || ""}</td>`;
        for(let i=1; i<=5; i++) {
          let cellValue = locFormsWeeks[i] && locFormsWeeks[i][metric] ? locFormsWeeks[i][metric] : "";
          row += `<td>${cellValue}</td>`;
        }
        return `<tr>${row}</tr>`;
      }).join('');
      formsTable.innerHTML = formsSectionRow + formsRows;

      // Mobile data-labels
      if (window.innerWidth <= 700) {
        let trs = mainMetricsTable.querySelectorAll("tbody tr:not(.leaderboard-row)");
        trs.forEach((tr, idx) => {
          let tds = tr.querySelectorAll("td");
          if (tds.length === 7) {
            let labels = [selectedStore ? selectedStore : "Metric", "Target", "Week 1", "Week 2", "Week 3", "Week 4", "Week 5"];
            tds.forEach((td, i) => {
              td.setAttribute("data-label", labels[i]);
              if (i !== 0) td.style.fontWeight = "400";
            });
          }
        });
      }
      selectionSection.classList.add('hidden');
      metricsSection.classList.add('hidden');
      gapsSection.classList.add('hidden');
      formsSection.classList.add('hidden');
      tableSection.classList.remove('hidden');
    }

    window.addEventListener('resize', function() {
      if (!tableSection.classList.contains('hidden')) renderTable();
    });

    populateAreaDropdown();
    loadAllData();
    loadAllGapsData();
    loadAllFormsData();
  </script>
</body>
</html>
